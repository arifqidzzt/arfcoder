{{define "content"}}
<div class="min-h-screen bg-background flex flex-col">
    {{template "navbar" .}}

    <main class="flex-grow py-16" x-data="orderDetailPage()">
        <div class="container-custom max-w-4xl">
            <div class="flex items-center gap-4 mb-8">
                <a href="/orders" class="p-2 border border-border rounded-lg hover:bg-gray-50 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                <h1 class="text-3xl font-bold tracking-tight">Detail Pesanan</h1>
                <span class="ml-auto font-mono text-muted-foreground">#{{.OrderID}}</span>
            </div>

            <div class="bg-white rounded-2xl border border-border overflow-hidden mb-8">
                <div class="p-6 border-b border-border bg-gray-50 flex justify-between items-center">
                    <div>
                        <p class="text-sm text-muted-foreground">Status Pesanan</p>
                        <span class="inline-flex items-center gap-2 font-bold px-3 py-1 rounded-full text-sm mt-1"
                            :class="{
                                  'bg-yellow-100 text-yellow-800': order.status === 'PENDING',
                                  'bg-blue-100 text-blue-800': order.status === 'PROCESSING',
                                  'bg-green-100 text-green-800': order.status === 'COMPLETED',
                                  'bg-red-100 text-red-800': order.status === 'CANCELLED'
                              }">
                            <span class="w-2 h-2 rounded-full bg-current animate-pulse"></span>
                            <span x-text="order.status"></span>
                        </span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-muted-foreground">Tanggal Pemesanan</p>
                        <p class="font-medium" x-text="formatDate(order.created_at)"></p>
                    </div>
                </div>

                <div class="p-8">
                    <div class="space-y-6">
                        <template x-for="item in order.items" :key="item.id">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center shrink-0">
                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold" x-text="item.product_name"></h3>
                                    <p class="text-sm text-muted-foreground"
                                        x-text="item.quantity + ' x ' + formatPrice(item.price)"></p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold" x-text="formatPrice(item.total_price)"></p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="border-t border-border mt-8 pt-6">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-xl">Total Pembayaran</span>
                            <span class="font-bold text-2xl" x-text="formatPrice(order.total)"></span>
                        </div>
                    </div>
                </div>

                <template x-if="order.status === 'PENDING'">
                    <div class="p-6 bg-yellow-50 border-t border-yellow-100 flex justify-between items-center">
                        <p class="text-yellow-800 text-sm">Pembayaran belum diselesaikan. Segera lakukan pembayaran.</p>
                        <button @click="payOrder"
                            class="px-6 py-2 bg-black text-white rounded-lg font-bold hover:bg-gray-800 transition-colors">
                            Bayar Sekarang
                        </button>
                    </div>
                </template>
            </div>

            <!-- Timeline -->
            <div class="bg-white rounded-2xl border border-border p-8">
                <h2 class="font-bold text-lg mb-6">Status Pengiriman</h2>
                <div class="relative pl-8 border-l-2 border-gray-100 space-y-8">
                    <div class="relative">
                        <div class="absolute -left-[39px] w-5 h-5 rounded-full border-4 border-white bg-green-500">
                        </div>
                        <p class="font-bold text-sm">Pesanan Dibuat</p>
                        <p class="text-xs text-muted-foreground" x-text="formatDate(order.created_at)"></p>
                    </div>
                    <!-- Add more timeline items dynamically based on status -->
                </div>
            </div>
        </div>
    </main>

    {{template "footer" .}}
</div>

<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="SB-Mid-client-xxxxxxxx"></script>
<script>
    function orderDetailPage() {
        return {
            orderId: '{{.OrderID}}',
            order: { items: [] }, // Initial state
            loading: true,

            async init() {
                try {
                    const token = Alpine.store('auth').token;
                    const response = await fetch('/api/user/orders/' + this.orderId, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'x-arf-secure-token': window.ArfSecurity.generateSecureHeader()
                        }
                    });

                    if (response.ok) {
                        this.order = await response.json();
                    } else {
                        window.location.href = '/orders';
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            async payOrder() {
                try {
                    const token = Alpine.store('auth').token;
                    const response = await fetch('/api/user/orders/' + this.orderId + '/pay', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'x-arf-secure-token': window.ArfSecurity.generateSecureHeader()
                        }
                    });

                    const result = await response.json();
                    if (result.snapToken) {
                        window.snap.pay(result.snapToken, {
                            onSuccess: () => location.reload(),
                            onPending: () => location.reload(),
                            onError: () => window.showToast('Pembayaran gagal', 'error')
                        });
                    }
                } catch (e) {
                    window.showToast('Gagal memproses pembayaran', 'error');
                }
            },

            formatPrice(price) {
                return 'Rp ' + new Intl.NumberFormat('id-ID').format(price || 0);
            },

            formatDate(dateString) {
                if (!dateString) return '-';
                return new Date(dateString).toLocaleDateString('id-ID', {
                    day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            }
        }
    }
</script>
{{end}}