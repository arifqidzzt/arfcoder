{{define "content"}}
<div class="min-h-screen bg-background flex flex-col">
    {{template "navbar" .}}

    <main class="flex-grow flex items-center justify-center px-4 py-12 relative overflow-hidden" x-data="otpPage()">
        <div class="absolute inset-0 bg-grid-black/[0.02] -z-10"></div>

        <div class="w-full max-w-md bg-white border border-border p-8 rounded-3xl shadow-xl text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                    </path>
                </svg>
            </div>

            <h1 class="text-2xl font-bold tracking-tight mb-2">Verifikasi Email</h1>
            <p class="text-muted-foreground mb-8">
                Masukkan kode 6 digit yang dikirim ke email <span class="font-bold text-black"
                    x-text="params.get('email')"></span>
            </p>

            <form @submit.prevent="handleSubmit" class="space-y-6">
                <div class="flex gap-2 justify-center">
                    <template x-for="(digit, index) in digits" :key="index">
                        <input type="text" maxlength="1" x-model="digits[index]" @input="handleInput($event, index)"
                            @keydown.backspace="handleBackspace($event, index)" @paste="handlePaste"
                            class="w-12 h-12 text-center text-2xl font-bold border border-gray-300 rounded-xl focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all"
                            required>
                    </template>
                </div>

                <div class="flex flex-col gap-3">
                    <button type="submit" :disabled="loading || digits.join('').length !== 6"
                        class="w-full py-3.5 bg-black text-white rounded-xl font-bold hover:bg-gray-800 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!loading">Verifikasi Kode</span>
                        <span x-show="loading">Memproses...</span>
                    </button>

                    <button type="button" @click="resendOtp" :disabled="resendTimer > 0"
                        class="text-sm font-medium text-muted-foreground hover:text-accent transition-colors">
                        <span x-show="resendTimer > 0">Kirim ulang dalam <span x-text="resendTimer"></span>s</span>
                        <span x-show="resendTimer === 0">Kirim kode baru</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    function otpPage() {
        return {
            params: new URLSearchParams(window.location.search),
            digits: ['', '', '', '', '', ''],
            loading: false,
            resendTimer: 60,

            init() {
                setInterval(() => {
                    if (this.resendTimer > 0) this.resendTimer--;
                }, 1000);

                // Focus first input
                setTimeout(() => {
                    document.querySelector('input').focus();
                }, 100);
            },

            handleInput(e, index) {
                const input = e.target;
                if (input.value.length === 1) {
                    if (index < 5) {
                        input.nextElementSibling.focus();
                    }
                }
            },

            handleBackspace(e, index) {
                if (e.target.value === '' && index > 0) {
                    e.target.previousElementSibling.focus();
                }
            },

            handlePaste(e) {
                e.preventDefault();
                const pasted = e.clipboardData.getData('text').slice(0, 6).split('');
                pasted.forEach((char, i) => {
                    if (i < 6) this.digits[i] = char;
                });
            },

            async handleSubmit() {
                this.loading = true;
                const code = this.digits.join('');
                const userId = this.params.get('userId');

                try {
                    const encrypted = window.ArfSecurity.encryptPayload({
                        userId: userId,
                        otp: code
                    });

                    const response = await fetch('/api/auth/verify-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-arf-secure-token': window.ArfSecurity.generateSecureHeader()
                        },
                        body: JSON.stringify(encrypted)
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.message || 'Kode salah');

                    window.showToast('Verifikasi berhasil!', 'success');
                    window.location.href = '/login';

                } catch (error) {
                    window.showToast(error.message, 'error');
                } finally {
                    this.loading = false;
                }
            },

            async resendOtp() {
                // Implementation for resend
                this.resendTimer = 60;
                window.showToast('Kode baru dikirim', 'info');
            }
        }
    }
</script>
{{end}}