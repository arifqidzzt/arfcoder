{{define "content"}}
<div class="min-h-screen bg-background flex flex-col">
    {{template "navbar" .}}

    <main class="flex-grow flex items-center justify-center px-4 py-12 relative overflow-hidden"
        x-data="adminVerifyPage()">
        <div class="absolute inset-0 bg-grid-black/[0.02] -z-10"></div>

        <div class="w-full max-w-md bg-white border border-border p-8 rounded-3xl shadow-xl text-center">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                    </path>
                </svg>
            </div>

            <h1 class="text-2xl font-bold tracking-tight mb-2">Verifikasi 2FA</h1>
            <p class="text-muted-foreground mb-8">
                Masukkan kode autentikator dari aplikasi keamanan Anda.
            </p>

            <form @submit.prevent="handleSubmit" class="space-y-6">
                <div class="flex gap-2 justify-center">
                    <template x-for="(digit, index) in digits" :key="index">
                        <input type="text" maxlength="1" x-model="digits[index]" @input="handleInput($event, index)"
                            @keydown.backspace="handleBackspace($event, index)" @paste="handlePaste"
                            class="w-12 h-12 text-center text-2xl font-bold border border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
                            required>
                    </template>
                </div>

                <button type="submit" :disabled="loading || digits.join('').length !== 6"
                    class="w-full py-3.5 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loading">Verifikasi Login</span>
                    <span x-show="loading">Memproses...</span>
                </button>
            </form>
        </div>
    </main>
</div>

<script>
    function adminVerifyPage() {
        return {
            params: new URLSearchParams(window.location.search),
            digits: ['', '', '', '', '', ''],
            loading: false,

            init() {
                setTimeout(() => {
                    document.querySelector('input').focus();
                }, 100);
            },

            handleInput(e, index) {
                const input = e.target;
                if (input.value.length === 1) {
                    if (index < 5) {
                        input.nextElementSibling.focus();
                    }
                }
            },

            handleBackspace(e, index) {
                if (e.target.value === '' && index > 0) {
                    e.target.previousElementSibling.focus();
                }
            },

            handlePaste(e) {
                e.preventDefault();
                const pasted = e.clipboardData.getData('text').slice(0, 6).split('');
                pasted.forEach((char, i) => {
                    if (i < 6) this.digits[i] = char;
                });
            },

            async handleSubmit() {
                this.loading = true;
                const code = this.digits.join('');
                const userId = this.params.get('userId');

                try {
                    const encrypted = window.ArfSecurity.encryptPayload({
                        userId: userId,
                        token: code
                    });

                    const response = await fetch('/api/auth/verify-2fa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-arf-secure-token': window.ArfSecurity.generateSecureHeader()
                        },
                        body: JSON.stringify(encrypted)
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.message || 'Kode validasi salah');

                    // Login Success
                    Alpine.store('auth').login(data.user, data.token);
                    window.showToast('Login berhasil!', 'success');

                    // Redirect based on role
                    if (data.user.role === 'ADMIN' || data.user.role === 'SUPER_ADMIN') {
                        window.location.href = '/admin';
                    } else {
                        window.location.href = '/';
                    }

                } catch (error) {
                    window.showToast(error.message, 'error');
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{{end}}