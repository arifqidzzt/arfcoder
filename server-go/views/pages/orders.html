{{define "content"}}
<div class="min-h-screen bg-background flex flex-col">
    {{template "navbar" .}}

    <main class="flex-grow py-16" x-data="ordersPage()">
        <div class="container-custom">
            <h1 class="text-3xl font-bold tracking-tight mb-8">Pesanan Saya</h1>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Sidebar -->
                <div class="md:col-span-1">
                    <div class="bg-white rounded-2xl border border-border overflow-hidden">
                        <div class="p-4 border-b border-border bg-secondary/10">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-bold">
                                    <template x-if="$store.auth.user">
                                        <span x-text="$store.auth.user.name.charAt(0).toUpperCase()"></span>
                                    </template>
                                </div>
                                <div class="overflow-hidden">
                                    <h3 class="font-bold truncate" x-text="$store.auth.user?.name">User</h3>
                                    <p class="text-xs text-muted-foreground truncate" x-text="$store.auth.user?.email">
                                        email@example.com</p>
                                </div>
                            </div>
                        </div>
                        <nav class="p-2 space-y-1">
                            <a href="/profile"
                                class="flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-sm transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Profil Saya
                            </a>
                            <a href="/orders"
                                class="flex items-center gap-3 px-3 py-2 bg-gray-100 rounded-lg text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                </svg>
                                Pesanan Saya
                            </a>
                            <button @click="$store.auth.logout()"
                                class="w-full flex items-center gap-3 px-3 py-2 hover:bg-red-50 text-red-600 rounded-lg text-sm transition-colors text-left mt-4">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                    </path>
                                </svg>
                                Keluar
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Content -->
                <div class="md:col-span-3 space-y-6">
                    <!-- Filters -->
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <button @click="filter = 'ALL'"
                            :class="filter === 'ALL' ? 'bg-black text-white' : 'bg-white border border-border hover:bg-gray-50'"
                            class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors">Semua</button>
                        <button @click="filter = 'PENDING'"
                            :class="filter === 'PENDING' ? 'bg-black text-white' : 'bg-white border border-border hover:bg-gray-50'"
                            class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors">Belum
                            Bayar</button>
                        <button @click="filter = 'PROCESSING'"
                            :class="filter === 'PROCESSING' ? 'bg-black text-white' : 'bg-white border border-border hover:bg-gray-50'"
                            class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors">Diproses</button>
                        <button @click="filter = 'COMPLETED'"
                            :class="filter === 'COMPLETED' ? 'bg-black text-white' : 'bg-white border border-border hover:bg-gray-50'"
                            class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors">Selesai</button>
                    </div>

                    <!-- Orders List -->
                    <template x-if="loading">
                        <div class="space-y-4">
                            <div class="bg-gray-100 h-32 rounded-2xl animate-pulse"></div>
                            <div class="bg-gray-100 h-32 rounded-2xl animate-pulse"></div>
                        </div>
                    </template>

                    <template x-if="!loading && filteredOrders.length === 0">
                        <div class="text-center py-16 bg-white rounded-2xl border border-border">
                            <div
                                class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="font-bold mb-2">Tidak Ada Pesanan</h3>
                            <p class="text-muted-foreground text-sm">Anda belum melakukan pemesanan apapun.</p>
                        </div>
                    </template>

                    <template x-for="order in filteredOrders" :key="order.id">
                        <div
                            class="bg-white rounded-2xl border border-border overflow-hidden hover:shadow-lg transition-shadow">
                            <div class="p-6">
                                <div
                                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                    <div>
                                        <div class="flex items-center gap-3 mb-1">
                                            <span class="font-mono text-sm text-muted-foreground"
                                                x-text="'#' + order.id.slice(0,8)"></span>
                                            <span class="px-2.5 py-0.5 rounded-full text-xs font-bold" :class="{
                                                      'bg-yellow-100 text-yellow-800': order.status === 'PENDING',
                                                      'bg-blue-100 text-blue-800': order.status === 'PROCESSING',
                                                      'bg-green-100 text-green-800': order.status === 'COMPLETED',
                                                      'bg-red-100 text-red-800': order.status === 'CANCELLED'
                                                  }" x-text="order.status"></span>
                                        </div>
                                        <p class="text-xs text-muted-foreground" x-text="formatDate(order.created_at)">
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-muted-foreground">Total Belanja</p>
                                        <p class="text-lg font-bold" x-text="formatPrice(order.total)"></p>
                                    </div>
                                </div>

                                <div class="border-t border-border pt-4 flex justify-end">
                                    <a :href="'/orders/' + order.id"
                                        class="px-4 py-2 border border-border rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors">
                                        Lihat Detail
                                    </a>
                                    <template x-if="order.status === 'PENDING'">
                                        <button @click="payOrder(order.id)"
                                            class="ml-3 px-4 py-2 bg-black text-white rounded-lg text-sm font-bold hover:bg-gray-800 transition-colors">
                                            Bayar Sekarang
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </main>

    {{template "footer" .}}
</div>

<script>
    function ordersPage() {
        return {
            orders: [],
            filter: 'ALL',
            loading: true,

            async init() {
                try {
                    const token = Alpine.store('auth').token;
                    const response = await fetch('/api/user/orders', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'x-arf-secure-token': window.ArfSecurity.generateSecureHeader()
                        }
                    });

                    if (response.ok) {
                        this.orders = await response.json();
                    }
                } catch (e) {
                    console.error('Failed to load orders', e);
                } finally {
                    this.loading = false;
                }
            },

            get filteredOrders() {
                if (this.filter === 'ALL') return this.orders;
                return this.orders.filter(o => o.status === this.filter);
            },

            formatPrice(price) {
                return 'Rp ' + new Intl.NumberFormat('id-ID').format(price);
            },

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('id-ID', {
                    day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            },

            payOrder(id) {
                // Initiate payment via Midtrans snap
                window.location.href = '/checkout/pay/' + id;
            }
        }
    }
</script>
{{end}}