{{define "content"}}
<div class="min-h-screen bg-gray-50 flex">
    <div class="flex-1 flex flex-col min-h-screen">
        <main class="flex-1 p-8" x-data="adminProductEdit()">
            <div class="max-w-3xl mx-auto">
                <h1 class="text-2xl font-bold mb-8">Edit Produk</h1>

                <form @submit.prevent="saveProduct"
                    class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 space-y-6">
                    <div class="space-y-2">
                        <label class="font-bold">Nama Produk</label>
                        <input type="text" x-model="form.name"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-black"
                            required>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="font-bold">Kategori</label>
                            <select x-model="form.category_id"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white focus:outline-none focus:border-black"
                                required>
                                <option value="">Pilih Kategori</option>
                                <template x-for="cat in categories" :key="cat.id">
                                    <option :value="cat.id" x-text="cat.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="font-bold">Link Demo (Opsional)</label>
                            <input type="url" x-model="form.demo_link"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-black">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="font-bold">Harga (Rp)</label>
                            <input type="number" x-model="form.price"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-black"
                                required>
                        </div>
                        <div class="space-y-2">
                            <label class="font-bold">Stok</label>
                            <input type="number" x-model="form.stock"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-black"
                                required>
                        </div>
                        <div class="space-y-2">
                            <label class="font-bold">Diskon (%)</label>
                            <input type="number" x-model="form.discount"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-black">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="font-bold">Deskripsi</label>
                        <textarea x-model="form.description" rows="5"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-black"></textarea>
                    </div>

                    <div class="pt-6 border-t border-gray-100 flex justify-end gap-4">
                        <a href="/admin/products"
                            class="px-6 py-3 border border-gray-200 rounded-xl font-bold hover:bg-gray-50 transition-colors">Batal</a>
                        <button type="submit" :disabled="loading"
                            class="px-6 py-3 bg-black text-white rounded-xl font-bold hover:bg-gray-800 transition-colors">
                            <span x-show="!loading">Update Produk</span>
                            <span x-show="loading">Menyimpan...</span>
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>

<script>
    function adminProductEdit() {
        return {
            form: {
                id: {{.Product.ID }
    },
    name: '{{.Product.Name}}',
        price: { {.Product.Price } },
    stock: { {.Product.Stock } },
    discount: { {.Product.Discount } },
    description: '{{.Product.Description}}',
        category_id: { {.Product.CategoryID } },
    demo_link: '{{.Product.DemoLink}}'
        },
    categories: [],
        loading: false,

            async init() {
        try {
            const token = Alpine.store('auth').token;
            const response = await fetch('/api/categories', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'x-arf-secure-token': window.ArfSecurity.generateSecureHeader()
                }
            });
            if (response.ok) this.categories = await response.json();
        } catch (e) {
            console.error(e);
        }
    },

        async saveProduct() {
        this.loading = true;
        try {
            const token = Alpine.store('auth').token;
            const response = await fetch('/api/products/' + this.form.id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'x-arf-secure-token': window.ArfSecurity.generateSecureHeader()
                },
                body: JSON.stringify(this.form)
            });

            if (response.ok) {
                window.showToast('Produk berhasil diupdate', 'success');
                setTimeout(() => window.location.href = '/admin/products', 1000);
            } else {
                throw new Error('Gagal update produk');
            }
        } catch (e) {
            window.showToast(e.message, 'error');
        } finally {
            this.loading = false;
        }
    }
    }
}
</script>
{{end}}