<div class="p-4 md:p-10 grid grid-cols-1 md:grid-cols-4 gap-8 h-[calc(100vh-100px)]" x-data="{ 
    selectedUser: null, 
    users: [], 
    messages: [], 
    input: '',
    fetchUsers() {
        fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + '{{.Token}}' } })
            .then(r => r.json())
            .then(d => { this.users = d; });
    },
    fetchMessages() {
        if (!this.selectedUser) return;
        fetch('/api/admin/chat/' + this.selectedUser, { headers: { 'Authorization': 'Bearer ' + '{{.Token}}' } })
            .then(r => r.json())
            .then(d => { this.messages = d; this.$nextTick(() => { this.$refs.scroll.scrollTop = this.$refs.scroll.scrollHeight; }); });
    },
    sendMessage() {
        if (!this.input || !this.selectedUser) return;
        fetch('/api/user/chat/send', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + '{{.Token}}' },
            body: JSON.stringify({ content: this.input, senderId: '{{.User.ID}}', isAdmin: true, targetUserId: this.selectedUser })
        }).then(() => { this.input = ''; this.fetchMessages(); });
    }
}" x-init="fetchUsers(); setInterval(() => fetchMessages(), 5000)">
    
    <!-- User List -->
    <div class="bg-white rounded-[2.5rem] border border-gray-100 shadow-soft overflow-hidden flex flex-col">
        <div class="p-6 border-b border-gray-100 font-black uppercase tracking-widest text-[10px] text-gray-400">Daftar Chat</div>
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <template x-for="u in users">
                <div @click="selectedUser = u.id; fetchMessages()" :class="selectedUser === u.id ? 'bg-black text-white' : 'hover:bg-gray-50 text-gray-600'" class="p-5 border-b border-gray-50 cursor-pointer transition-all">
                    <p class="font-black uppercase text-sm tracking-tight" x-text="u.name"></p>
                    <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest" x-text="u.email"></p>
                </div>
            </template>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="md:col-span-3 bg-white rounded-[2.5rem] border border-gray-100 shadow-soft flex flex-col overflow-hidden">
        <template x-if="selectedUser">
            <div class="flex flex-col h-full">
                <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="font-black uppercase tracking-widest text-[10px]">Aktif Chatting</span>
                </div>

                <div x-ref="scroll" class="flex-1 p-8 overflow-y-auto space-y-6 bg-gray-50/30 custom-scrollbar">
                    <template x-for="msg in messages">
                        <div :class="msg.isAdmin ? 'justify-end' : 'justify-start'" class="flex">
                            <div :class="msg.isAdmin ? 'bg-black text-white' : 'bg-white border border-gray-200 text-gray-600'" class="max-w-[70%] p-4 rounded-2xl text-xs font-bold shadow-sm" x-text="msg.content"></div>
                        </div>
                    </template>
                </div>

                <div class="p-6 bg-white border-t border-gray-100">
                    <div class="flex gap-4">
                        <input x-model="input" @keyup.enter="sendMessage()" placeholder="Tulis balasan..." class="flex-1 bg-gray-50 border-none rounded-2xl px-6 py-4 text-sm font-bold outline-none focus:ring-2 focus:ring-black/5" />
                        <button @click="sendMessage()" class="bg-black text-white px-8 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-gray-800 transition-all">Kirim</button>
                    </div>
                </div>
            </div>
        </template>
        <template x-if="!selectedUser">
            <div class="flex-1 flex flex-col items-center justify-center text-center p-10">
                <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>
                </div>
                <h3 class="font-black uppercase tracking-tighter text-xl mb-2">Pilih Pengguna</h3>
                <p class="text-gray-400 text-sm max-w-xs">Silakan pilih salah satu pengguna di sebelah kiri untuk mulai membalas pesan.</p>
            </div>
        </template>
    </div>
</div>
