{{if .User}}
<div class="fixed bottom-8 right-8 z-50" x-data="{ 
    isOpen: false, 
    messages: [], 
    input: '',
    fetchMessages() {
        if (!this.isOpen) return;
        fetch('/api/user/chat/history/me', { headers: { 'Authorization': 'Bearer ' + '{{.Token}}' } })
            .then(r => r.json())
            .then(d => { 
                this.messages = d;
                this.$nextTick(() => { this.$refs.scroll.scrollTop = this.$refs.scroll.scrollHeight; });
            });
    },
    sendMessage() {
        if (!this.input) return;
        const body = JSON.stringify({ content: this.input, senderId: '{{.User.ID}}', isAdmin: false });
        fetch('/api/user/chat/send', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + '{{.Token}}' },
            body: body
        }).then(() => { this.input = ''; this.fetchMessages(); });
    }
}" x-init="setInterval(() => fetchMessages(), 5000)">
    
    <!-- Toggle Button -->
    <button @click="isOpen = !isOpen; if(isOpen) fetchMessages();" class="bg-black text-white p-4 rounded-full shadow-elevated hover:scale-110 transition-transform">
        <svg x-show="!isOpen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>
        <svg x-show="isOpen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>

    <!-- Chat Box -->
    <div x-show="isOpen" x-cloak class="absolute bottom-20 right-0 w-80 h-[450px] bg-white rounded-3xl shadow-elevated border border-gray-100 flex flex-col overflow-hidden animate-in slide-in-from-bottom-5 duration-300">
        <div class="p-5 bg-black text-white flex justify-between items-center">
            <span class="font-black text-xs uppercase tracking-widest">Live Support</span>
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
        </div>

        <div x-ref="scroll" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50/50 custom-scrollbar">
            <template x-for="msg in messages">
                <div :class="msg.senderId === '{{.User.ID}}' ? 'justify-end' : 'justify-start'" class="flex">
                    <div :class="msg.senderId === '{{.User.ID}}' ? 'bg-black text-white' : 'bg-white border border-gray-200 text-gray-600'" class="max-w-[80%] p-3 rounded-2xl text-xs font-bold shadow-sm" x-text="msg.content"></div>
                </div>
            </template>
        </div>

        <div class="p-4 bg-white border-t border-gray-100 flex gap-2">
            <input x-model="input" @keyup.enter="sendMessage()" placeholder="Ketik pesan..." class="flex-1 bg-gray-50 border-none rounded-xl px-4 py-2 text-xs outline-none focus:ring-2 focus:ring-black/5" />
            <button @click="sendMessage()" class="p-2 bg-black text-white rounded-xl hover:bg-gray-800 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
        </div>
    </div>
</div>
{{end}}
