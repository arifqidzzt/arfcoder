{{define "content"}}
<!-- CHECKOUT PAGE -->
<div class="min-h-screen bg-gray-50" x-data="checkoutPage()">
    <div class="container-custom py-12">
        <h1 class="text-3xl font-bold mb-8">Checkout</h1>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Form Section -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Shipping -->
                <div class="bg-white rounded-2xl border border-border p-6">
                    <h2 class="font-bold text-lg mb-4">Alamat Pengiriman</h2>
                    <textarea x-model="address" rows="3" placeholder="Alamat lengkap..."
                        class="w-full p-4 border border-border rounded-xl focus:outline-none focus:border-black"></textarea>
                    <input type="text" x-model="notes" placeholder="Catatan (opsional)"
                        class="w-full mt-4 p-4 border border-border rounded-xl focus:outline-none focus:border-black">
                </div>
                <!-- Voucher -->
                <div class="bg-white rounded-2xl border border-border p-6">
                    <h2 class="font-bold text-lg mb-4">Kode Voucher</h2>
                    <div class="flex gap-3">
                        <input type="text" x-model="voucherCode" placeholder="Masukkan kode"
                            class="flex-1 p-4 border border-border rounded-xl">
                        <button @click="applyVoucher()"
                            class="px-6 py-4 bg-black text-white rounded-xl font-medium">Terapkan</button>
                    </div>
                    <p x-show="voucherError" class="text-red-500 text-sm mt-2" x-text="voucherError"></p>
                    <p x-show="voucherDiscount > 0" class="text-green-600 text-sm mt-2"
                        x-text="'Diskon: ' + formatPrice(voucherDiscount)"></p>
                </div>
            </div>
            <!-- Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl border border-border p-6 sticky top-24">
                    <h2 class="font-bold text-lg mb-6">Ringkasan</h2>
                    <div class="space-y-3 text-sm mb-6">
                        <template x-for="item in cart.items" :key="item.id">
                            <div class="flex justify-between"><span
                                    x-text="item.name + ' x' + item.quantity"></span><span
                                    x-text="formatPrice(item.price * item.quantity)"></span></div>
                        </template>
                    </div>
                    <div class="border-t pt-4 space-y-2 mb-6">
                        <div class="flex justify-between"><span>Subtotal</span><span
                                x-text="formatPrice(subtotal)"></span></div>
                        <div x-show="voucherDiscount > 0" class="flex justify-between text-green-600">
                            <span>Diskon</span><span x-text="'-' + formatPrice(voucherDiscount)"></span></div>
                        <div class="flex justify-between font-bold text-lg pt-2 border-t"><span>Total</span><span
                                x-text="formatPrice(total)"></span></div>
                    </div>
                    <button @click="processCheckout()" :disabled="loading || !address"
                        class="w-full py-4 bg-black text-white rounded-xl font-bold disabled:bg-gray-400">
                        <span x-text="loading ? 'Memproses...' : 'Bayar Sekarang'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Midtrans Snap -->
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{.MidtransClientKey}}"></script>
<script>
    function checkoutPage() {
        return {
            address: '', notes: '', voucherCode: '', voucherDiscount: 0, voucherError: '', loading: false,
            get cart() { return Alpine.store('app')?.cart || { items: [] }; },
            get subtotal() { return this.cart.items.reduce((s, i) => s + (i.price * i.quantity), 0); },
            get total() { return Math.max(0, this.subtotal - this.voucherDiscount); },
            async applyVoucher() {
                if (!this.voucherCode) return;
                try {
                    const data = await api.post('/vouchers/apply', { code: this.voucherCode, subtotal: this.subtotal });
                    this.voucherDiscount = data.discount || 0; this.voucherError = '';
                    showToast('Voucher berhasil diterapkan', 'success');
                } catch (e) { this.voucherError = e.message; this.voucherDiscount = 0; }
            },
            async processCheckout() {
                this.loading = true;
                try {
                    const data = await api.post('/orders/create', { address: this.address, notes: this.notes, voucherCode: this.voucherCode || undefined });
                    if (data.snapToken) {
                        window.snap.pay(data.snapToken, {
                            onSuccess: () => { showToast('Pembayaran berhasil!', 'success'); Alpine.store('app').clearCart(); window.location.href = '/orders'; },
                            onPending: () => { showToast('Menunggu pembayaran', 'info'); window.location.href = '/orders'; },
                            onError: () => { showToast('Pembayaran gagal', 'error'); },
                            onClose: () => { showToast('Dibatalkan', 'info'); }
                        });
                    }
                } catch (e) { showToast(e.message || 'Checkout gagal', 'error'); }
                finally { this.loading = false; }
            }
        };
    }
</script>
{{end}}