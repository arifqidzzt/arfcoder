{{define "admin_content"}}
<!-- ADMIN WHATSAPP -->
<div x-data="adminWhatsApp()">
    <h1 class="text-2xl font-bold mb-8">WhatsApp Gateway</h1>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Connection Status -->
        <div class="bg-white rounded-2xl border border-border p-6">
            <h2 class="font-bold text-lg mb-4">Status Koneksi</h2>
            <div class="flex items-center gap-4 mb-6">
                <div class="w-4 h-4 rounded-full" :class="connected ? 'bg-green-500' : 'bg-red-500'"></div>
                <span class="font-medium" x-text="connected ? 'Terhubung' : 'Terputus'"></span>
            </div>
            <template x-if="!connected && qrCode">
                <div class="text-center">
                    <p class="mb-4">Scan QR Code dengan WhatsApp:</p><img :src="qrCode" class="mx-auto max-w-[200px]">
                </div>
            </template>
            <div class="flex gap-3 mt-6">
                <button @click="checkStatus()" class="px-4 py-2 border rounded-lg">Refresh Status</button>
                <button @click="reconnect()" x-show="!connected"
                    class="px-4 py-2 bg-black text-white rounded-lg">Reconnect</button>
                <button @click="disconnect()" x-show="connected"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg">Disconnect</button>
            </div>
        </div>
        <!-- Send Message -->
        <div class="bg-white rounded-2xl border border-border p-6">
            <h2 class="font-bold text-lg mb-4">Kirim Pesan</h2>
            <div class="space-y-4">
                <div><label class="text-sm">Nomor Tujuan</label><input type="text" x-model="form.to"
                        placeholder="628123456789" class="w-full mt-1 p-3 border rounded-xl"></div>
                <div><label class="text-sm">Pesan</label><textarea x-model="form.message" rows="4"
                        class="w-full mt-1 p-3 border rounded-xl"></textarea></div>
            </div>
            <button @click="sendMessage()" :disabled="!connected || sending"
                class="w-full mt-6 py-3 bg-black text-white rounded-xl font-medium disabled:bg-gray-400"
                x-text="sending ? 'Mengirim...' : 'Kirim'"></button>
        </div>
    </div>
    <!-- Message History -->
    <div class="bg-white rounded-2xl border border-border p-6 mt-6">
        <h2 class="font-bold text-lg mb-4">Riwayat Pesan Terakhir</h2>
        <div class="space-y-3">
            <template x-for="msg in history" :key="msg.id">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium" x-text="msg.to"></p>
                        <p class="text-sm text-gray-500 truncate max-w-md" x-text="msg.message"></p>
                    </div>
                    <span class="text-xs text-gray-400" x-text="formatDate(msg.createdAt)"></span>
                </div>
            </template>
            <template x-if="history.length === 0">
                <p class="text-gray-400 text-center py-4">Belum ada riwayat</p>
            </template>
        </div>
    </div>
</div>
<script>
    function adminWhatsApp() {
        return {
            connected: false, qrCode: null, form: { to: '', message: '' }, sending: false, history: [],
            async init() { await this.checkStatus(); await this.loadHistory(); },
            async checkStatus() { try { const data = await api.get('/admin/whatsapp/status'); this.connected = data.connected; this.qrCode = data.qrCode; } catch (e) { } },
            async reconnect() { try { const data = await api.post('/admin/whatsapp/connect'); this.qrCode = data.qrCode; showToast('Scan QR Code', 'info'); } catch (e) { showToast(e.message, 'error'); } },
            async disconnect() { try { await api.post('/admin/whatsapp/disconnect'); this.connected = false; showToast('Disconnected', 'success'); } catch (e) { showToast(e.message, 'error'); } },
            async sendMessage() { this.sending = true; try { await api.post('/admin/whatsapp/send', this.form); showToast('Pesan terkirim', 'success'); this.form = { to: '', message: '' }; await this.loadHistory(); } catch (e) { showToast(e.message, 'error'); } finally { this.sending = false; } },
            async loadHistory() { try { this.history = await api.get('/admin/whatsapp/history') || []; } catch (e) { } }
        };
    }
</script>
{{end}}