{{define "content"}}
<!-- ORDERS PAGE -->
<div class="min-h-screen bg-gray-50" x-data="ordersPage()">
    <div class="container-custom py-12">
        <h1 class="text-3xl font-bold mb-8">Pesanan Saya</h1>
        <!-- Tabs -->
        <div class="flex gap-2 mb-8 overflow-x-auto pb-2">
            <button @click="tab = 'all'" :class="tab === 'all' ? 'bg-black text-white' : 'bg-white border'"
                class="px-4 py-2 rounded-lg font-medium whitespace-nowrap">Semua</button>
            <button @click="tab = 'UNPAID'" :class="tab === 'UNPAID' ? 'bg-black text-white' : 'bg-white border'"
                class="px-4 py-2 rounded-lg font-medium whitespace-nowrap">Belum Bayar</button>
            <button @click="tab = 'PROCESSING'"
                :class="tab === 'PROCESSING' ? 'bg-black text-white' : 'bg-white border'"
                class="px-4 py-2 rounded-lg font-medium whitespace-nowrap">Diproses</button>
            <button @click="tab = 'COMPLETED'" :class="tab === 'COMPLETED' ? 'bg-black text-white' : 'bg-white border'"
                class="px-4 py-2 rounded-lg font-medium whitespace-nowrap">Selesai</button>
        </div>
        <!-- Orders -->
        <div class="space-y-4">
            <template x-if="loading">
                <div class="text-center py-12 text-gray-400">Memuat...</div>
            </template>
            <template x-if="!loading && filteredOrders.length === 0">
                <div class="bg-white rounded-2xl border p-12 text-center">
                    <p class="text-gray-400">Tidak ada pesanan</p>
                </div>
            </template>
            <template x-for="order in filteredOrders" :key="order.id">
                <div class="bg-white rounded-2xl border border-border p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-sm text-gray-500" x-text="'Invoice: ' + order.invoiceNumber"></p>
                            <p class="text-sm text-gray-400" x-text="formatDate(order.createdAt)"></p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-bold"
                            :class="order.status === 'COMPLETED' ? 'bg-green-100 text-green-700' : order.status === 'UNPAID' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700'"
                            x-text="order.status"></span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <template x-for="item in order.items" :key="item.id">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden">
                                    <img :src="item.product?.images?.[0] || 'https://placehold.co/100'"
                                        class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium" x-text="item.product?.name"></p>
                                    <p class="text-sm text-gray-500" x-text="'x' + item.quantity"></p>
                                </div>
                                <p class="font-medium" x-text="formatPrice(item.price * item.quantity)"></p>
                            </div>
                        </template>
                    </div>
                    <div class="flex justify-between items-center pt-4 border-t">
                        <p class="font-bold">Total: <span x-text="formatPrice(order.total)"></span></p>
                        <template x-if="order.status === 'UNPAID' && order.snapToken">
                            <button @click="payNow(order.snapToken)"
                                class="px-4 py-2 bg-black text-white rounded-lg font-medium">Bayar</button>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{.MidtransClientKey}}"></script>
<script>
    function ordersPage() {
        return {
            orders: [], loading: true, tab: 'all',
            get filteredOrders() { return this.tab === 'all' ? this.orders : this.orders.filter(o => o.status === this.tab); },
            async init() { await this.loadOrders(); },
            async loadOrders() {
                this.loading = true;
                try { const data = await api.get('/orders'); this.orders = data || []; }
                catch (e) { console.error(e); } finally { this.loading = false; }
            },
            payNow(token) { window.snap.pay(token, { onSuccess: () => { showToast('Berhasil!', 'success'); this.loadOrders(); }, onPending: () => this.loadOrders(), onError: () => showToast('Gagal', 'error') }); }
        };
    }
</script>
{{end}}